# VPC

- サブネット
 - サブネット毎にルーティング設定
 - 最小は/28
 - 利用できないIPアドレス
  - .0: NWアドレス
  - .1: VPCルータ
  - .2: DNSサービス
  - .3: AWSで予約
  - .255: ブロードキャストアドレス
  
- Elastic ネットワークインタフェース (ENI)
 - プライベートIP / Elastic_IP / Macアドレス / セキュリティグループを維持可能
 - 固定のIPアドレスを設定することも可能
 - VPCのDHCP機能を設定変更が可能
 
- Amazon DNSサーバ
 - VPCのネットワーク範囲(CIDR)のアドレスに+2をプラスしたIP
  - (10.0.0.0/16の場合、10.0.0.2)
  - 169.254.169.253
 - VPC内のEC2インスタンスからのみ参照可能
 
- DNS機能の有効化とホストへのDNS名割り当て
 - Enable DNS resolution
  - 基本はYesとする
  - NoにするとVPCのDNS機能が無効になる
 - Enable DNS hostname
  - TrueにするとDNS名が割り当てられなくなる
  - Enable DNS resolutionをTrueにしないと有効にならない
  
- プライベートホストゾーン
 - Route53のプライベートホストゾーンによるカスタムDNSドメインが利用可能
 - VPC内のインスタンスのみ参照可能
 - VPCピアリング、Class-Linkから参照可能
 
- インターネットゲートウェイ
 - VPC内のリソースにインターネットへの接続を提供
 - VPCにアタッチすることで利用可能
 - サブネットでルーティング指定
 - 単一障害点や帯域幅のボトルネックは存在しない
 
- 仮想ルータ
 - VPC内のすべてのサブネット間はネットワーク的に疎通可能
  - 制御したい場合はネットワークACLを利用
 - サブネットのネットワークアドレス+1がすべてのサブネットのゲートウェイとなる
 - ユーザが操作するコンポーネントではなく、暗示的に動作している
 
- ルートテーブル
 - サブネット内の通信がどの宛先のネットワークに対してどのコンポーネントに転送されるべきかの定義を記述
 - 各サブネットに一つ定義
 - 一つのルーティングテーブルには複数のサブネットがマッピング可能
 - 必ずVPCのCIDRがlocalとして登録されている
 - サブネットのデフォルトの状態ではメインルートテーブルが設定されている

- メインルートテーブルとカスタムルートテーブル
 - メインルートテーブル
  - VPCを作成したときに自動的に割り当てられるルートテーブル
  - サブネットでルートテーブルの指定がない場合はメインルートテーブルが割り当てられる
 - カスタムルートテーブル
  - 任意で作成したルートテーブル
  - 明示的に各サブネットへ割り当てることが可能
  - カスタムルートテーブルをメインテーブルに変更することが可能

- NATゲートウェイ
 - マネージドNATサービス
 - プライベートサブネットのリソースがインターネットまたはAWSクラウドへ通信するために必要
 - EIPの割り当て可能
 - 高いパフォーマンス(最大10Gbpsバースト)
 - 高可用性
 - アベイラビリティゾーン毎に設置するのがベストプラクティス
 - コスト
  - 利用時間 / NATを経由したデータ量に課金
  
 - VPCエンドポイント for s3
  - VPCエンドポイントをVPCに作成し、プライベートサブネットからAWSクラウド上のs3にバケットにアクセスすることが可能
  - VPCエンドポイントポリシーでアクセス制御が可能
  - 追加費用無し(トラフィック課金もなし)
  
- VPCエンドポイントのメリット
 - S3アクセスのめのインターネットゲートウェイやNATインスタンスが不要
 - 安全、高い信頼性
 - 設定が容易
 
 - バーチャルプライベートゲートウェイ(VGW)
  - オフィスやデータセンタなどのオンプレミスとのVPN接続のためのエンドポイントとなる仮想ルータ
  - Direct COnnectのエンドポイントとしても利用
  - 1VPCあたり1つのVGWのみアタッチ可能
  - 1つのVGWで複数のVPN, Direct Connectのコネクションを終端
  - 単一障害点や帯域幅のボトルネックは存在しない

- カスタマーゲートウェイ(CGW)
 - AWSとのVPNを接続する物理的または仮想敵なルータ
 - VGWとVPN接続を行う
 - お客様にて準備、設定する
 
- VPC Peering
 - 2つのVPC間でトラフィックのルーティングが可能
 - 異なるアカウントでもクロスアカウントのVPC間をピア接続することも可能
 - 単一障害点や帯域幅ボトルネックは存在しない
 
- AWSクラウドとVPC
 - VPC内と外のどちらにリソースが存在するかによって異なる
 - VPCからAWSクラウド(マネージドサービス)のリソースはIGW経由の通信になる
 - s3へのアクセスはVPCエンドポイントを利用
 
 
